<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aniwave 2.0</title>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body {
    transition: background-color 0.4s, color 0.4s;
  }
  .dark-mode {
    background-color: #121212;
    color: #e0e0e0;
  }
  /* Card Hover */
  .anime-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .anime-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 30px rgba(0,0,0,0.3);
  }
  /* Button Ripple */
  button {
    position: relative;
    overflow: hidden;
  }
  button:focus {
    outline: none;
  }
  button.ripple:after {
    content: "";
    position: absolute;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
  }
  button:active.ripple:after {
    transform: scale(2);
    opacity: 0;
  }
  @keyframes ripple {
    to {
      transform: scale(2);
      opacity: 0;
    }
  }
  /* Scrollbar for watchlist */
  #watch-list {
    max-height: 220px;
    overflow-y: auto;
  }
  #watch-list::-webkit-scrollbar {
    width: 8px;
  }
  #watch-list::-webkit-scrollbar-thumb {
    background: #4f46e5;
    border-radius: 4px;
  }
</style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans min-h-screen flex flex-col transition-colors duration-500">

<div class="container mx-auto p-6 flex flex-col flex-grow">
  <!-- Header -->
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-4xl font-extrabold tracking-tight text-indigo-600 dark:text-indigo-400">Aniwave 2.0</h1>
    <button id="darkToggle" aria-label="Toggle Dark Mode" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white px-4 py-2 rounded shadow ripple flex items-center gap-2 transition">
      <i data-lucide="moon"></i> Dark Mode
    </button>
  </header>

  <!-- Auth Section -->
  <section id="auth" class="text-center space-y-4">
    <p class="text-lg">Sign in to build your personalized watch list</p>
    <div class="flex justify-center gap-4 flex-wrap">
      <button onclick="netlifyIdentity.open('login')" class="ripple bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded shadow flex items-center gap-2 transition" type="button">
        <i data-lucide="log-in"></i> Login
      </button>
      <button onclick="netlifyIdentity.open('signup')" class="ripple bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded shadow flex items-center gap-2 transition" type="button">
        <i data-lucide="user-plus"></i> Sign Up
      </button>
    </div>
  </section>

  <!-- Main App Section -->
  <main id="app" class="hidden flex flex-col flex-grow">

    <!-- Welcome & Logout -->
    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
      <h2 class="text-3xl font-semibold text-indigo-700 dark:text-indigo-300">Welcome, <span id="username"></span></h2>
      <button onclick="logout()" class="ripple bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded shadow flex items-center gap-2 transition" type="button">
        <i data-lucide="log-out"></i> Logout
      </button>
    </div>

    <!-- Search Filters -->
    <section class="mb-6">
      <form onsubmit="event.preventDefault(); searchAnime();" class="flex flex-wrap gap-3 items-center">
        <input id="search" type="text" placeholder="Search anime title..." class="flex-grow min-w-[220px] px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
        <select id="genre" class="px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="">All Genres</option>
          <option>Action</option>
          <option>Adventure</option>
          <option>Comedy</option>
          <option>Drama</option>
          <option>Fantasy</option>
          <option>Romance</option>
          <option>Sci-Fi</option>
        </select>
        <select id="season" class="px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="">All Seasons</option>
          <option>Winter</option>
          <option>Spring</option>
          <option>Summer</option>
          <option>Fall</option>
        </select>
        <input id="year" type="number" placeholder="Year" min="1917" max="2099" class="w-24 px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
        <select id="sort" class="px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
          <option value="score">Top Rated</option>
        </select>
        <button type="submit" class="ripple bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow flex items-center gap-2 transition">
          <i data-lucide="search"></i> Search
        </button>
      </form>
    </section>

    <!-- Recommended Anime -->
    <section class="mb-8">
      <h3 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">Recommended Airing Anime</h3>
      <div id="recommended-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </section>

    <!-- Search Results -->
    <section class="mb-8">
      <h3 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">Search Results</h3>
      <div id="anime-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
      <div id="pagination" class="mt-6 flex justify-center space-x-3"></div>
    </section>

    <!-- Watch List -->
    <section>
      <h3 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">Your Watch List</h3>
      <ul id="watch-list" class="list-disc pl-6 max-h-56 overflow-y-auto border border-gray-300 dark:border-gray-700 rounded p-4 bg-white dark:bg-gray-800 shadow">
        <!-- Watchlist items inserted here -->
      </ul>
    </section>
  </main>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm z-50 p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
  <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-auto relative">
    <button onclick="closeModal()" aria-label="Close modal" class="absolute top-4 right-4 text-red-600 hover:text-red-700 transition text-xl font-bold" type="button">âœ•</button>
    <h2 id="modal-title" class="text-3xl font-bold mb-3 text-indigo-700 dark:text-indigo-400"></h2>
    <img id="modal-image" alt="Anime cover" class="rounded mb-4 w-full max-h-96 object-contain shadow" />
    <p id="modal-description" class="mb-4 text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line"></p>
    <div id="modal-video" class="aspect-w-16 aspect-h-9 mb-4 hidden">
      <iframe id="trailer-video" class="w-full h-64 rounded shadow-lg" src="" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>
    </div>
    <div class="flex justify-end gap-4">
      <button onclick="addToWatchList()" class="ripple bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow flex items-center gap-2 transition" type="button">
        <i data-lucide="plus"></i> Add to Watch List
      </button>
      <button onclick="closeModal()" class="ripple bg-gray-400 hover:bg-gray-500 text-gray-900 px-6 py-2 rounded shadow flex items-center gap-2 transition" type="button">
        <i data-lucide="x"></i> Close
      </button>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentUser = null;
  let watchList = [];
  let currentPage = 1;
  let lastSearchParams = {};

  // Elements
  const authSection = document.getElementById('auth');
  const appSection = document.getElementById('app');
  const usernameEl = document.getElementById('username');
  const darkToggleBtn = document.getElementById('darkToggle');
  const searchInput = document.getElementById('search');
  const genreSelect = document.getElementById('genre');
  const seasonSelect = document.getElementById('season');
  const yearInput = document.getElementById('year');
  const sortSelect = document.getElementById('sort');
  const animeListEl = document.getElementById('anime-list');
  const paginationEl = document.getElementById('pagination');
  const recommendedListEl = document.getElementById('recommended-list');
  const watchListEl = document.getElementById('watch-list');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalImage = document.getElementById('modal-image');
  const modalDescription = document.getElementById('modal-description');
  const modalVideo = document.getElementById('modal-video');
  const trailerVideo = document.getElementById('trailer-video');

  let modalCurrentAnime = null;

  // Initialization
  window.onload = () => {
    lucide.createIcons();
    initializeAuth();
    initializeDarkMode();
  };

  // -----------------------------
  // NETLIFY IDENTITY AUTH LOGIC
  // -----------------------------

  function initializeAuth() {
    if(!window.netlifyIdentity) {
      alert('Netlify Identity Widget failed to load.');
      return;
    }
    window.netlifyIdentity.on('init', user => {
      currentUser = user;
      updateUI();
    });
    window.netlifyIdentity.on('login', user => {
      currentUser = user;
      saveWatchListFromStorage();
      updateUI();
      window.netlifyIdentity.close();
    });
    window.netlifyIdentity.on('logout', () => {
      currentUser = null;
      watchList = [];
      updateUI();
    });
    window.netlifyIdentity.init();
  }

  function updateUI() {
    if(currentUser) {
      authSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      usernameEl.textContent = currentUser.user_metadata.full_name || currentUser.email || "User";
      loadWatchListFromStorage();
      loadRecommended();
      // Clear previous search results:
      animeListEl.innerHTML = '';
      paginationEl.innerHTML = '';
    } else {
      authSection.classList.remove('hidden');
      appSection.classList.add('hidden');
    }
  }

  function logout() {
    if(window.netlifyIdentity) {
      window.netlifyIdentity.logout();
    }
  }

  // -----------------------------
  // DARK MODE TOGGLE
  // -----------------------------

  function initializeDarkMode() {
    // Check stored preference
    const darkPref = localStorage.getItem('darkMode');
    if(darkPref === 'enabled') {
      document.documentElement.classList.add('dark');
      darkToggleBtn.innerHTML = '<i data-lucide="sun"></i> Light Mode';
    } else {
      darkToggleBtn.innerHTML = '<i data-lucide="moon"></i> Dark Mode';
    }
    lucide.createIcons();

    darkToggleBtn.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      if(document.documentElement.classList.contains('dark')) {
        localStorage.setItem('darkMode', 'enabled');
        darkToggleBtn.innerHTML = '<i data-lucide="sun"></i> Light Mode';
      } else {
        localStorage.setItem('darkMode', 'disabled');
        darkToggleBtn.innerHTML = '<i data-lucide="moon"></i> Dark Mode';
      }
      lucide.createIcons();
    });
  }

  // -----------------------------
  // SEARCH LOGIC
  // -----------------------------

  async function searchAnime(page = 1) {
    const query = searchInput.value.trim();
    const genre = genreSelect.value;
    const season = seasonSelect.value.toLowerCase();
    const year = yearInput.value.trim();
    const sort = sortSelect.value;

    if(!query && !genre && !season && !year) {
      alert("Please enter a search term or select a filter.");
      return;
    }

    lastSearchParams = { query, genre, season, year, sort };
    currentPage = page;

    animeListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">Loading...</p>`;
    paginationEl.innerHTML = '';

    try {
      let url = `https://api.jikan.moe/v4/anime?page=${page}&limit=12&order_by=score&sort=${sort}`;

      if(query) url += `&q=${encodeURIComponent(query)}`;
      if(genre) url += `&genres=${encodeURIComponent(genre)}`;
      if(season) url += `&season=${season}`;
      if(year) url += `&year=${year}`;

      const res = await fetch(url);
      const data = await res.json();

      if(!data.data || data.data.length === 0) {
        animeListEl.innerHTML = `<p class="col-span-full text-center text-red-500">No results found.</p>`;
        return;
      }

      renderAnimeList(data.data);
      renderPagination(data.pagination);
    } catch (error) {
      animeListEl.innerHTML = `<p class="col-span-full text-center text-red-500">Error fetching results. Please try again later.</p>`;
      console.error(error);
    }
  }

  function renderAnimeList(animeArray) {
    animeListEl.innerHTML = '';
    animeArray.forEach(anime => {
      animeListEl.appendChild(createAnimeCard(anime));
    });
    lucide.createIcons();
  }

  function renderPagination(pagination) {
    paginationEl.innerHTML = '';

    const current = pagination.current_page;
    const last = pagination.last_visible_page;

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'ripple bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed';
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = current === 1;
    prevBtn.onclick = () => searchAnime(current - 1);
    paginationEl.appendChild(prevBtn);

    // Page numbers (show max 5 pages for simplicity)
    let startPage = Math.max(1, current - 2);
    let endPage = Math.min(last, current + 2);

    for(let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `ripple px-3 py-1 rounded border ${i === current ? 'bg-indigo-700 text-white' : 'bg-white dark:bg-gray-800 text-indigo-700 dark:text-indigo-400 border-indigo-600 dark:border-indigo-400'}`;
      pageBtn.textContent = i;
      if(i !== current) {
        pageBtn.onclick = () => searchAnime(i);
      } else {
        pageBtn.disabled = true;
      }
      paginationEl.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'ripple bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed';
    nextBtn.textContent = 'Next';
    nextBtn.disabled = current === last;
    nextBtn.onclick = () => searchAnime(current + 1);
    paginationEl.appendChild(nextBtn);

    lucide.createIcons();
  }

  // -----------------------------
  // RECOMMENDED AIRING ANIME
  // -----------------------------

  async function loadRecommended() {
    recommendedListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">Loading...</p>`;
    try {
      // Top airing anime from Jikan API
      const res = await fetch('https://api.jikan.moe/v4/top/anime?filter=airing&limit=6');
      const data = await res.json();

      if(!data.data || data.data.length === 0) {
        recommendedListEl.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to load recommendations.</p>`;
        return;
      }

      recommendedListEl.innerHTML = '';
      data.data.forEach(anime => {
        recommendedListEl.appendChild(createAnimeCard(anime));
      });
      lucide.createIcons();
    } catch {
      recommendedListEl.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to load recommendations.</p>`;
    }
  }

  // -----------------------------
  // CREATE ANIME CARD
  // -----------------------------

  function createAnimeCard(anime) {
    const card = document.createElement('div');
    card.className = 'anime-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden cursor-pointer flex flex-col';
    card.tabIndex = 0;
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', `View details for ${anime.title}`);

    card.onclick = () => openModal(anime);
    card.onkeypress = (e) => { if(e.key === 'Enter') openModal(anime); };

    const img = document.createElement('img');
    img.src = anime.images?.jpg?.image_url || anime.images?.webp?.image_url || '';
    img.alt = anime.title + " cover";
    img.className = 'w-full object-cover h-52';

    const info = document.createElement('div');
    info.className = 'p-4 flex-grow flex flex-col justify-between';

    const title = document.createElement('h4');
    title.textContent = anime.title;
    title.className = 'font-semibold text-lg text-indigo-700 dark:text-indigo-400 mb-2 truncate';

    const score = document.createElement('p');
    score.innerHTML = `<i data-lucide="star" class="inline-block mr-1 text-yellow-400"></i> Score: ${anime.score ?? "N/A"}`;
    score.className = 'text-sm mb-2 text-gray-700 dark:text-gray-300';

    const episodes = document.createElement('p');
    episodes.textContent = `Episodes: ${anime.episodes ?? "?"}`;
    episodes.className = 'text-sm text-gray-600 dark:text-gray-400';

    info.appendChild(title);
    info.appendChild(score);
    info.appendChild(episodes);

    card.appendChild(img);
    card.appendChild(info);

    return card;
  }

  // -----------------------------
  // MODAL LOGIC
  // -----------------------------

  function openModal(anime) {
    modalCurrentAnime = anime;

    modalTitle.textContent = anime.title;
    modalImage.src = anime.images?.jpg?.large_image_url || anime.images?.jpg?.image_url || '';
    modalImage.alt = anime.title + " cover";
    modalDescription.textContent = anime.synopsis || "No description available.";

    // Trailer iframe
    if(anime.trailer?.embed_url) {
      modalVideo.classList.remove('hidden');
      trailerVideo.src = anime.trailer.embed_url + '?autoplay=1&mute=1';
      trailerVideo.setAttribute('title', anime.title + ' trailer');
    } else {
      modalVideo.classList.add('hidden');
      trailerVideo.src = '';
      trailerVideo.removeAttribute('title');
    }

    modal.classList.remove('hidden');
    modal.focus();

    // Trap focus inside modal (basic)
    document.addEventListener('keydown', trapModalFocus);
  }

  function closeModal() {
    modal.classList.add('hidden');
    trailerVideo.src = '';
    modalCurrentAnime = null;
    document.removeEventListener('keydown', trapModalFocus);
  }

  // Trap focus inside modal for accessibility
  function trapModalFocus(e) {
    if(e.key === 'Tab') {
      const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      if(e.shiftKey) {
        if(document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        }
      } else {
        if(document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    }
    if(e.key === 'Escape') {
      closeModal();
    }
  }

  // -----------------------------
  // WATCH LIST LOGIC (localStorage per user)
  // -----------------------------

  function loadWatchListFromStorage() {
    if(!currentUser) return;
    const key = `watchlist_${currentUser.id}`;
    const stored = localStorage.getItem(key);
    watchList = stored ? JSON.parse(stored) : [];
    renderWatchList();
  }

  function saveWatchListToStorage() {
    if(!currentUser) return;
    const key = `watchlist_${currentUser.id}`;
    localStorage.setItem(key, JSON.stringify(watchList));
  }

  function addToWatchList() {
    if(!modalCurrentAnime) return;
    // Prevent duplicates
    if(watchList.some(a => a.mal_id === modalCurrentAnime.mal_id)) {
      alert('This anime is already in your watch list!');
      return;
    }
    watchList.push({
      mal_id: modalCurrentAnime.mal_id,
      title: modalCurrentAnime.title,
      url: modalCurrentAnime.url,
    });
    saveWatchListToStorage();
    renderWatchList();
    alert(`Added "${modalCurrentAnime.title}" to your watch list.`);
    closeModal();
  }

  function removeFromWatchList(mal_id) {
    watchList = watchList.filter(a => a.mal_id !== mal_id);
    saveWatchListToStorage();
    renderWatchList();
  }

  function renderWatchList() {
    watchListEl.innerHTML = '';
    if(watchList.length === 0) {
      watchListEl.innerHTML = '<li class="text-gray-500 dark:text-gray-400">Your watch list is empty.</li>';
      return;
    }
    watchList.forEach(anime => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center mb-1';

      const link = document.createElement('a');
      link.href = anime.url;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.textContent = anime.title;
      link.className = 'text-indigo-700 dark:text-indigo-400 hover:underline flex-grow truncate';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'ripple ml-4 text-red-600 hover:text-red-800 transition';
      removeBtn.setAttribute('aria-label', `Remove ${anime.title} from watch list`);
      removeBtn.innerHTML = `<i data-lucide="trash-2"></i>`;
      removeBtn.onclick = () => removeFromWatchList(anime.mal_id);

      li.appendChild(link);
      li.appendChild(removeBtn);

      watchListEl.appendChild(li);
    });
    lucide.createIcons();
  }
</script>

</body>
</html>
