<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aniwave</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      background-color: #f9fafb;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode body {
      background-color: #1f2937;
      color: #f9fafb;
    }
    #modal {
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
    }
  </style>
</head>
<body class="font-sans">
  <div class="container mx-auto p-4 min-h-screen flex flex-col">
    <!-- Auth -->
    <div id="auth" class="text-center space-y-4">
      <h1 class="text-4xl font-bold">Aniwave</h1>
      <p class="text-lg">Sign in to start building your watch list!</p>
      <div class="flex justify-center space-x-4">
        <button onclick="netlifyIdentity.open('login')" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow">
          <i data-lucide="log-in"></i> Login
        </button>
        <button onclick="netlifyIdentity.open('signup')" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">
          <i data-lucide="user-plus"></i> Sign Up
        </button>
      </div>
    </div>

    <!-- Main app -->
    <div id="app" style="display:none" class="flex-grow flex flex-col">
      <div class="flex flex-wrap justify-between items-center mb-6">
        <h2 class="text-3xl font-bold">Welcome to Aniwave, <span id="username"></span></h2>
        <div class="flex space-x-4">
          <button onclick="toggleDarkMode()" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded shadow">
            <i data-lucide="moon"></i> Toggle Theme
          </button>
          <button onclick="logout()" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow">
            <i data-lucide="log-out"></i> Logout
          </button>
        </div>
      </div>

      <div class="mb-6">
        <div class="flex gap-2 flex-wrap">
          <input type="text" id="search" placeholder="Search anime..." class="border p-2 w-full md:w-auto flex-grow rounded" />
          <select id="genre" class="border p-2 rounded">
            <option value="">All Genres</option>
            <option value="Action">Action</option>
            <option value="Comedy">Comedy</option>
            <option value="Romance">Romance</option>
            <option value="Drama">Drama</option>
            <option value="Fantasy">Fantasy</option>
            <option value="Sci-Fi">Sci-Fi</option>
          </select>
          <button onclick="searchAnime()" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow">
            <i data-lucide="search"></i> Search
          </button>
        </div>
      </div>

      <h3 class="text-2xl font-semibold mb-2">Recommended Anime</h3>
      <div id="recommended-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

      <h3 class="text-2xl font-semibold mb-2">Search Results</h3>
      <div id="anime-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <h3 class="text-2xl font-semibold mt-6">Your Watch List</h3>
      <ul id="watch-list" class="list-disc pl-6"></ul>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-xl w-full relative overflow-auto max-h-[90vh]">
      <button onclick="closeModal()" class="absolute top-2 right-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">âœ•</button>
      <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
      <img id="modal-image" class="w-full h-60 object-cover rounded mb-4" />
      <p id="modal-description" class="mb-4 text-sm"></p>
      <div id="modal-video" class="aspect-w-16 aspect-h-9 mb-4">
        <iframe id="trailer-video" class="w-full h-60 rounded" src="" frameborder="0" allowfullscreen></iframe>
      </div>
      <button onclick="addToWatchList()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
        <i data-lucide="plus-circle"></i> Add to Watch List
      </button>
    </div>
  </div>

<script>
  // Initialize Netlify Identity
  netlifyIdentity.on('init', user => {
    if (user) {
      showApp(user);
    }
  });

  netlifyIdentity.on('login', user => {
    showApp(user);
    netlifyIdentity.close();
  });

  netlifyIdentity.on('logout', () => {
    hideApp();
  });

  function showApp(user) {
    document.getElementById('auth').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('username').textContent = user.user_metadata.full_name || user.email;
    loadRecommended();
    loadWatchList();
  }

  function hideApp() {
    document.getElementById('auth').style.display = 'block';
    document.getElementById('app').style.display = 'none';
    clearLists();
  }

  function logout() {
    netlifyIdentity.logout();
  }

  // Dark mode toggle
  function toggleDarkMode() {
    document.documentElement.classList.toggle('dark-mode');
    lucide.createIcons();
  }

  // Variables
  const recommendedListEl = document.getElementById('recommended-list');
  const animeListEl = document.getElementById('anime-list');
  const watchListEl = document.getElementById('watch-list');
  const modalEl = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalImage = document.getElementById('modal-image');
  const modalDesc = document.getElementById('modal-description');
  const trailerVideo = document.getElementById('trailer-video');

  let currentAnime = null;
  let watchList = [];

  // Clear lists when user logs out
  function clearLists() {
    recommendedListEl.innerHTML = '';
    animeListEl.innerHTML = '';
    watchListEl.innerHTML = '';
    currentAnime = null;
    watchList = [];
  }

  // Load recommended anime (top airing/popular from Jikan API)
  async function loadRecommended() {
    recommendedListEl.innerHTML = 'Loading...';
    try {
      const response = await fetch('https://api.jikan.moe/v4/top/anime?filter=airing&limit=6');
      const data = await response.json();
      recommendedListEl.innerHTML = '';
      data.data.forEach(anime => {
        const card = createAnimeCard(anime);
        recommendedListEl.appendChild(card);
      });
    } catch (err) {
      recommendedListEl.innerHTML = 'Failed to load recommended anime.';
    }
  }

  // Search anime by title and genre filter
  async function searchAnime() {
    const query = document.getElementById('search').value.trim();
    const genre = document.getElementById('genre').value;
    if (!query && !genre) {
      alert('Please enter a search term or select a genre.');
      return;
    }
    animeListEl.innerHTML = 'Searching...';
    try {
      // Build URL for Jikan search
      let url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(query)}&limit=12`;
      if (genre) {
        // Jikan API uses genre IDs. Map genre names to ids
        const genreMap = {
          'Action': 1,
          'Adventure': 2,
          'Comedy': 4,
          'Drama': 8,
          'Fantasy': 10,
          'Romance': 22,
          'Sci-Fi': 24,
        };
        if (genreMap[genre]) {
          url += `&genres=${genreMap[genre]}`;
        }
      }
      const response = await fetch(url);
      const data = await response.json();
      animeListEl.innerHTML = '';
      if (data.data.length === 0) {
        animeListEl.innerHTML = '<p>No results found.</p>';
        return;
      }
      data.data.forEach(anime => {
        const card = createAnimeCard(anime);
        animeListEl.appendChild(card);
      });
    } catch (err) {
      animeListEl.innerHTML = 'Search failed.';
    }
  }

  // Create anime card element
  function createAnimeCard(anime) {
    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-gray-700 rounded shadow p-4 cursor-pointer flex flex-col';
    card.innerHTML = `
      <img src="${anime.images.jpg.image_url}" alt="${anime.title}" class="w-full h-48 object-cover rounded mb-2" />
      <h4 class="font-semibold text-lg mb-1">${anime.title}</h4>
      <p class="text-sm mb-2 text-gray-700 dark:text-gray-300">${anime.synopsis ? anime.synopsis.substring(0, 100) + '...' : 'No description available.'}</p>
      <div class="mt-auto flex justify-between items-center">
        <span class="text-yellow-400 font-bold">${anime.score ? anime.score.toFixed(1) : 'N/A'}</span>
        <button class="flex items-center gap-1 text-blue-600 hover:text-blue-800" title="View Details">
          <i data-lucide="info"></i>
        </button>
      </div>
    `;
    // Open modal on clicking card or info button
    card.onclick = () => openModal(anime);
    card.querySelector('button').onclick = e => {
      e.stopPropagation();
      openModal(anime);
    };

    lucide.createIcons();
    return card;
  }

  // Open modal with anime info + trailer
  async function openModal(anime) {
    currentAnime = anime;
    modalTitle.textContent = anime.title;
    modalImage.src = anime.images.jpg.large_image_url || anime.images.jpg.image_url;
    modalDesc.textContent = anime.synopsis || 'No description available.';

    // Fetch trailer video from YouTube API
    trailerVideo.src = '';
    modalEl.classList.remove('hidden');
    // Search YouTube with anime title + "trailer"
    const apiKey = 'YOUR_YOUTUBE_API_KEY'; // <-- Replace this with your API Key
    const query = encodeURIComponent(anime.title + ' trailer');
    try {
      const ytResponse = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${query}&key=${apiKey}`);
      const ytData = await ytResponse.json();
      if (ytData.items && ytData.items.length > 0) {
        const videoId = ytData.items[0].id.videoId;
        trailerVideo.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      } else {
        trailerVideo.src = '';
      }
    } catch (err) {
      trailerVideo.src = '';
    }
  }

  function closeModal() {
    modalEl.classList.add('hidden');
    trailerVideo.src = '';
  }

  // Add current anime to watch list
  function addToWatchList() {
    if (!currentAnime) return;
    if (watchList.find(a => a.mal_id === currentAnime.mal_id)) {
      alert('Already in your watch list!');
      return;
    }
    watchList.push(currentAnime);
    saveWatchList();
    renderWatchList();
    alert(`Added "${currentAnime.title}" to your watch list!`);
  }

  // Save watch list to localStorage
  function saveWatchList() {
    localStorage.setItem('aniwave-watchlist', JSON.stringify(watchList));
  }

  // Load watch list from localStorage
  function loadWatchList() {
    const saved = localStorage.getItem('aniwave-watchlist');
    watchList = saved ? JSON.parse(saved) : [];
    renderWatchList();
  }

  // Render watch list UI
  function renderWatchList() {
    watchListEl.innerHTML = '';
    if (watchList.length === 0) {
      watchListEl.innerHTML = '<p>Your watch list is empty.</p>';
      return;
    }
    watchList.forEach(anime => {
      const li = document.createElement('li');
      li.textContent = anime.title;
      watchListEl.appendChild(li);
    });
  }
lucide.createIcons();

netlifyIdentity.on('init', user => {
  if (user) {
    showApp(user);
  }
});

netlifyIdentity.init();
  
</script>

</body>
</html>
