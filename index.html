<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aniwave 2.0</title>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body {
    transition: background-color 0.4s, color 0.4s;
  }
  .dark-mode {
    background-color: #121212;
    color: #e0e0e0;
  }
  /* Card Hover */
  .anime-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .anime-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 30px rgba(0,0,0,0.3);
  }
  /* Button Ripple */
  button {
    position: relative;
    overflow: hidden;
  }
  button:focus {
    outline: none;
  }
  button.ripple:after {
    content: "";
    position: absolute;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
  }
  button:active.ripple:after {
    transform: scale(2);
    opacity: 0;
  }
  @keyframes ripple {
    to {
      transform: scale(2);
      opacity: 0;
    }
  }
  /* Scrollbar for watchlist */
  #watch-list {
    max-height: 220px;
    overflow-y: auto;
  }
  #watch-list::-webkit-scrollbar {
    width: 8px;
  }
  #watch-list::-webkit-scrollbar-thumb {
    background: #4f46e5;
    border-radius: 4px;
  }
</style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans min-h-screen flex flex-col transition-colors duration-500">

<div class="container mx-auto p-6 flex flex-col flex-grow">
  <!-- Header -->
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-4xl font-extrabold tracking-tight text-indigo-600 dark:text-indigo-400">Aniwave 2.0</h1>
    <button id="darkToggle" aria-label="Toggle Dark Mode" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white px-4 py-2 rounded shadow ripple flex items-center gap-2 transition">
      <i data-lucide="moon"></i> Dark Mode
    </button>
  </header>

  <!-- Auth Section -->
  <section id="auth" class="text-center space-y-4">
    <p class="text-lg">Sign in to build your personalized watch list</p>
    <div class="flex justify-center gap-4">
      <button onclick="netlifyIdentity.open('login')" class="ripple bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded shadow flex items-center gap-2 transition">
        <i data-lucide="log-in"></i> Login
      </button>
      <button onclick="netlifyIdentity.open('signup')" class="ripple bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded shadow flex items-center gap-2 transition">
        <i data-lucide="user-plus"></i> Sign Up
      </button>
    </div>
  </section>

  <!-- Main App Section -->
  <main id="app" class="hidden flex flex-col flex-grow">

    <!-- Welcome & Logout -->
    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
      <h2 class="text-3xl font-semibold text-indigo-700 dark:text-indigo-300">Welcome, <span id="username"></span></h2>
      <button onclick="logout()" class="ripple bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded shadow flex items-center gap-2 transition">
        <i data-lucide="log-out"></i> Logout
      </button>
    </div>

    <!-- Search Filters -->
    <section class="mb-6">
      <form onsubmit="event.preventDefault(); searchAnime();" class="flex flex-wrap gap-3 items-center">
        <input id="search" type="text" placeholder="Search anime title..." class="flex-grow min-w-[220px] px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
        <select id="genre" class="px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="">All Genres</option>
          <option>Action</option>
          <option>Adventure</option>
          <option>Comedy</option>
          <option>Drama</option>
          <option>Fantasy</option>
          <option>Romance</option>
          <option>Sci-Fi</option>
        </select>
        <select id="season" class="px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="">All Seasons</option>
          <option>Winter</option>
          <option>Spring</option>
          <option>Summer</option>
          <option>Fall</option>
        </select>
        <input id="year" type="number" placeholder="Year" min="1917" max="2099" class="w-24 px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
        <select id="sort" class="px-4 py-2 border border-gray-300 rounded shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
          <option value="score">Top Rated</option>
        </select>
        <button type="submit" class="ripple bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow flex items-center gap-2 transition">
          <i data-lucide="search"></i> Search
        </button>
      </form>
    </section>

    <!-- Recommended Anime -->
    <section class="mb-8">
      <h3 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">Recommended Airing Anime</h3>
      <div id="recommended-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </section>

    <!-- Search Results -->
    <section class="mb-8">
      <h3 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">Search Results</h3>
      <div id="anime-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
      <div id="pagination" class="mt-6 flex justify-center space-x-3"></div>
    </section>

    <!-- Watch List -->
    <section>
      <h3 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">Your Watch List</h3>
      <ul id="watch-list" class="list-disc pl-6 max-h-56 overflow-y-auto border border-gray-300 dark:border-gray-700 rounded p-4 bg-white dark:bg-gray-800 shadow">
        <!-- Watchlist items inserted here -->
      </ul>
    </section>
  </main>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm z-50 p-4">
  <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-auto relative">
    <button onclick="closeModal()" aria-label="Close modal" class="absolute top-4 right-4 text-red-600 hover:text-red-700 transition text-xl font-bold">âœ•</button>
    <h2 id="modal-title" class="text-3xl font-bold mb-3 text-indigo-700 dark:text-indigo-400"></h2>
    <img id="modal-image" alt="Anime cover" class="rounded mb-4 w-full max-h-96 object-contain shadow" />
    <p id="modal-description" class="mb-4 text-gray-700 dark:text-gray-300 leading-relaxed"></p>
    <div id="modal-video" class="aspect-w-16 aspect-h-9 mb-4">
      <iframe id="trailer-video" class="w-full h-64 rounded shadow-lg" src="" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="flex justify-end gap-4">
      <button onclick="addToWatchList()" class="ripple bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow flex items-center gap-2 transition">
        <i data-lucide="plus-circle"></i> Add to Watch List
      </button>
    </div>
  </div>
</div>

<script>
  // Initialize Lucide icons
  lucide.createIcons();

  // Netlify Identity init
  netlifyIdentity.on('init', user => {
    if(user) showApp(user);
  });
  netlifyIdentity.on('login', user => {
    showApp(user);
    netlifyIdentity.close();
  });
  netlifyIdentity.on('logout', () => {
    hideApp();
  });
  if(!netlifyIdentity.initialized) {
    netlifyIdentity.init();
    netlifyIdentity.initialized = true;
  }

  // Elements
  const authEl = document.getElementById('auth');
  const appEl = document.getElementById('app');
  const usernameEl = document.getElementById('username');
  const recommendedListEl = document.getElementById('recommended-list');
  const animeListEl = document.getElementById('anime-list');
  const watchListEl = document.getElementById('watch-list');
  const modalEl = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalImage = document.getElementById('modal-image');
  const modalDesc = document.getElementById('modal-description');
  const trailerVideo = document.getElementById('trailer-video');
  const darkToggleBtn = document.getElementById('darkToggle');

  // State
  let currentUser = null;
  let currentAnime = null;
  let watchList = [];
  let searchPage = 1;
  let totalPages = 1;
  let lastSearchParams = {};

  // Show/hide app based on auth
  function showApp(user) {
    currentUser = user;
    authEl.classList.add('hidden');
    appEl.classList.remove('hidden');
    usernameEl.textContent = user.user_metadata?.full_name || user.email || 'User';
    loadRecommended();
    loadWatchList();
  }
  function hideApp() {
    currentUser = null;
    authEl.classList.remove('hidden');
    appEl.classList.add('hidden');
    clearLists();
  }
  function logout() {
    netlifyIdentity.logout();
  }

  // Load recommended airing anime
  async function loadRecommended() {
    recommendedListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">Loading...</p>`;
    try {
      const res = await fetch('https://api.jikan.moe/v4/top/anime?filter=airing&limit=6');
      const data = await res.json();
      if(!data.data) throw new Error("No data");
      recommendedListEl.innerHTML = '';
      data.data.forEach(anime => {
        recommendedListEl.appendChild(createAnimeCard(anime));
      });
    } catch {
      recommendedListEl.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to load recommendations.</p>`;
    }
  }

  // Search anime with filters & pagination
  async function searchAnime(page=1) {
    const query = document.getElementById('search').value.trim();
    const genre = document.getElementById('genre').value;
    const season = document.getElementById('season').value;
    const year = document.getElementById('year').value.trim();
    const sort = document.getElementById('sort').value;

    if(!query && !genre && !season && !year) {
      alert('Please enter a search term or select at least one filter.');
      return;
    }

    animeListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">Searching...</p>`;
    document.getElementById('pagination').innerHTML = '';

    // Save search params for pagination
    lastSearchParams = { query, genre, season, year, sort };
    searchPage = page;

    // Genre to ID map
    const genreMap = {
      'Action': 1,
      'Adventure': 2,
      'Comedy': 4,
      'Drama': 8,
      'Fantasy': 10,
      'Romance': 22,
      'Sci-Fi': 24
    };

    // Build URL with filters
    let url = `https://api.jikan.moe/v4/anime?page=${page}&limit=12&order_by=${sort === 'score' ? 'score' : 'start_date'}&sort=${sort === 'asc' ? 'asc' : 'desc'}`;

    if(query) url += `&q=${encodeURIComponent(query)}`;
    if(genre && genreMap[genre]) url += `&genres=${genreMap[genre]}`;
    if(season) url += `&season=${season.toLowerCase()}`;
    if(year) url += `&year=${year}`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      if(!data.data || data.data.length === 0) {
        animeListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">No results found.</p>`;
        return;
      }
      animeListEl.innerHTML = '';
      data.data.forEach(anime => {
        animeListEl.appendChild(createAnimeCard(anime));
      });

      // Pagination
      totalPages = data.pagination.last_visible_page || 1;
      renderPagination();
    } catch {
      animeListEl.innerHTML = `<p class="col-span-full text-center text-red-500">Search failed. Try again later.</p>`;
    }
  }

  // Render pagination buttons
  function renderPagination() {
    const container = document.getElementById('pagination');
    container.innerHTML = '';

    if(totalPages <= 1) return;

    // Prev button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'Prev';
    prevBtn.disabled = searchPage <= 1;
    prevBtn.className = `ripple px-4 py-2 rounded shadow ${prevBtn.disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`;
    prevBtn.onclick = () => searchAnime(searchPage - 1);
    container.appendChild(prevBtn);

    // Current page display
    const pageInfo = document.createElement('span');
    pageInfo.textContent = `Page ${searchPage} of ${totalPages}`;
    pageInfo.className = 'px-4 py-2 text-indigo-600 dark:text-indigo-300';
    container.appendChild(pageInfo);

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next';
    nextBtn.disabled = searchPage >= totalPages;
    nextBtn.className = `ripple px-4 py-2 rounded shadow ${nextBtn.disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`;
    nextBtn.onclick = () => searchAnime(searchPage + 1);
    container.appendChild(nextBtn);
  }

  // Create anime card element
  function createAnimeCard(anime) {
    const li = document.createElement('div');
    li.tabIndex = 0;
    li.setAttribute('role', 'button');
    li.setAttribute('aria-label', `Open details for ${anime.title}`);
    li.className = 'anime-card cursor-pointer bg-white dark:bg-gray-800 rounded-lg shadow p-3 flex flex-col gap-2 hover:shadow-lg transition';
    li.onclick = () => openModal(anime);
    li.onkeypress = e => { if(e.key === 'Enter') openModal(anime); };

    const img = document.createElement('img');
    // Use large images if available, fallback otherwise
    img.src = anime.images?.jpg.large_image_url || anime.images?.jpg.image_url || '';
    img.alt = anime.title;
    img.className = 'rounded-md w-full h-52 object-cover shadow-sm';

    const title = document.createElement('h4');
    title.textContent = anime.title;
    title.className = 'font-semibold text-lg truncate';

    const info = document.createElement('p');
    info.textContent = `Score: ${anime.score || 'N/A'} | Episodes: ${anime.episodes || '?'} | ${anime.season ? anime.season.charAt(0).toUpperCase() + anime.season.slice(1) : 'Unknown Season'} ${anime.year || ''}`;
    info.className = 'text-sm text-gray-600 dark:text-gray-400 truncate';

    li.appendChild(img);
    li.appendChild(title);
    li.appendChild(info);

    return li;
  }

  // Modal open & close
  function openModal(anime) {
    currentAnime = anime;
    modalTitle.textContent = anime.title;
    modalImage.src = anime.images?.jpg.large_image_url || anime.images?.jpg.image_url || '';
    modalImage.alt = anime.title;
    modalDesc.textContent = anime.synopsis || "No description available.";
    if(anime.trailer?.embed_url) {
      trailerVideo.src = anime.trailer.embed_url;
      trailerVideo.parentElement.style.display = 'block';
    } else {
      trailerVideo.src = '';
      trailerVideo.parentElement.style.display = 'none';
    }
    modalEl.classList.remove('hidden');
    modalEl.focus();
  }
  function closeModal() {
    modalEl.classList.add('hidden');
    trailerVideo.src = '';
  }

  // Watchlist load, save, render
  function loadWatchList() {
    if(!currentUser) return;
    const saved = localStorage.getItem('watchlist_' + currentUser.email);
    watchList = saved ? JSON.parse(saved) : [];
    renderWatchList();
  }
  function saveWatchList() {
    if(!currentUser) return;
    localStorage.setItem('watchlist_' + currentUser.email, JSON.stringify(watchList));
  }
  function renderWatchList() {
    watchListEl.innerHTML = '';
    if(watchList.length === 0) {
      watchListEl.innerHTML = '<li class="text-gray-500 dark:text-gray-400">Your watch list is empty.</li>';
      return;
    }
    watchList.forEach((anime, idx) => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center gap-4 py-1';
      const title = document.createElement('span');
      title.textContent = anime.title;
      title.className = 'truncate max-w-xs';
      const removeBtn = document.createElement('button');
      removeBtn.innerHTML = '<i data-lucide="trash-2"></i>';
      removeBtn.setAttribute('aria-label', `Remove ${anime.title} from watch list`);
      removeBtn.className = 'text-red-600 hover:text-red-800 transition';
      removeBtn.onclick = () => {
        watchList.splice(idx, 1);
        saveWatchList();
        renderWatchList();
      };
      li.appendChild(title);
      li.appendChild(removeBtn);
      watchListEl.appendChild(li);
      lucide.createIcons(); // Refresh icons for dynamic buttons
    });
  }

  // Add current anime to watchlist
  function addToWatchList() {
    if(!currentAnime || !currentUser) return alert('Select an anime and login first.');
    if(watchList.find(a => a.mal_id === currentAnime.mal_id)) {
      alert('Anime already in watch list.');
      return;
    }
    watchList.push({ mal_id: currentAnime.mal_id, title: currentAnime.title });
    saveWatchList();
    renderWatchList();
    alert(`Added "${currentAnime.title}" to your watch list!`);
  }

  // Clear lists on logout
  function clearLists() {
    recommendedListEl.innerHTML = '';
    animeListEl.innerHTML = '';
    watchListEl.innerHTML = '';
    document.getElementById('pagination').innerHTML = '';
  }

  // Dark mode toggle
  darkToggleBtn.onclick = () => {
    document.body.classList.toggle('dark-mode');
    // Change button text & icon
    if(document.body.classList.contains('dark-mode')) {
      darkToggleBtn.innerHTML = '<i data-lucide="sun"></i> Light Mode';
    } else {
      darkToggleBtn.innerHTML = '<i data-lucide="moon"></i> Dark Mode';
    }
    lucide.createIcons();
  };

  // Start with recommended airing anime visible but app hidden until login
  loadRecommended();

  // Accessibility: close modal with ESC
  window.addEventListener('keydown', e => {
    if(e.key === 'Escape' && !modalEl.classList.contains('hidden')) closeModal();
  });

</script>

</body>
</html>
